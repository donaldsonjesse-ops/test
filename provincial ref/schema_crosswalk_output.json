{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Crosswalk Output Schema",
  "description": "Schema for final crosswalk output comparing Alberta codes to provincial equivalents",
  "version": "1.0",
  
  "definitions": {
    
    "alberta_source": {
      "type": "object",
      "required": ["ab_code", "ab_description", "ab_fee"],
      "properties": {
        "ab_code": {
          "type": "string",
          "description": "Alberta billing code"
        },
        "ab_description": {
          "type": "string",
          "description": "Description"
        },
        "ab_fee": {
          "type": "number",
          "description": "Base fee in dollars"
        },
        "ab_clinical_definition": {
          "type": ["string", "null"],
          "description": "Full clinical service definition"
        },
        "ab_modality": {
          "type": "string",
          "enum": ["telephone", "video", "both", "in_person"],
          "description": "Service delivery modality"
        },
        "ab_minimum_time": {
          "type": ["integer", "null"],
          "description": "Minimum minutes required"
        },
        "ab_exclusions": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Same-day exclusion codes"
        },
        "ab_patient_initiated": {
          "type": ["boolean", "null"],
          "description": "Must be patient-initiated"
        },
        "ab_documentation_required": {
          "type": ["string", "null"],
          "description": "Documentation requirements"
        }
      }
    },
    
    "comparison_attributes": {
      "type": "object",
      "properties": {
        "fee_ratio": {
          "type": "number",
          "description": "target_fee / ab_fee"
        },
        "fee_difference": {
          "type": "number",
          "description": "target_fee - ab_fee (dollars)"
        },
        "modality_match": {
          "type": "boolean",
          "description": "Whether modality coverage matches"
        },
        "modality_detail": {
          "type": ["string", "null"],
          "description": "Explanation of modality comparison"
        },
        "time_requirement_comparison": {
          "type": "string",
          "enum": ["same", "target_more_restrictive", "target_less_restrictive", "not_comparable"],
          "description": "How time requirements compare"
        },
        "time_detail": {
          "type": ["string", "null"],
          "description": "Explanation of time comparison"
        },
        "exclusions_similar": {
          "type": "boolean",
          "description": "Whether exclusion structures are similar"
        },
        "key_differences": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Human-readable list of key differences"
        },
        "comparability_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Overall comparability score (1-100)"
        },
        "comparability_notes": {
          "type": ["string", "null"],
          "description": "Explanation of score and limitations"
        }
      }
    },
    
    "applicable_modifier": {
      "type": "object",
      "required": ["modifier_code", "modifier_name"],
      "properties": {
        "modifier_code": {
          "type": "string",
          "description": "Modifier code"
        },
        "modifier_name": {
          "type": "string",
          "description": "Description"
        },
        "modifier_value": {
          "type": ["number", "null"],
          "description": "Amount or percentage"
        },
        "modifier_unit": {
          "type": "string",
          "enum": ["flat", "percentage"],
          "description": "How applied"
        },
        "modifier_type": {
          "type": "string",
          "description": "Type of modifier"
        },
        "conditions": {
          "type": ["string", "null"],
          "description": "When applicable"
        }
      }
    },
    
    "provenance": {
      "type": "object",
      "required": ["reference_version"],
      "properties": {
        "reference_version": {
          "type": "string",
          "description": "Version of province reference used"
        },
        "reference_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "When reference was extracted"
        },
        "match_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "When matching was performed"
        },
        "match_model": {
          "type": ["string", "null"],
          "description": "AI model used for matching"
        },
        "source_pages": {
          "type": "array",
          "items": {"type": "integer"},
          "description": "All pages referenced"
        },
        "rule_references": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Rules that informed attributes"
        },
        "requires_manual_review": {
          "type": "boolean",
          "default": false,
          "description": "Flag for QA"
        },
        "review_reasons": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Why review is needed"
        }
      }
    },
    
    "matched_code": {
      "type": "object",
      "required": ["province", "code", "match_type", "match_confidence"],
      "properties": {
        "province": {
          "type": "string",
          "description": "Province code"
        },
        "code": {
          "type": "string",
          "description": "Matched billing code"
        },
        "match_type": {
          "type": "string",
          "enum": ["primary", "add_on", "alternative"],
          "description": "Type of match"
        },
        "description": {
          "type": "string",
          "description": "Code description from reference"
        },
        "base_fee": {
          "type": ["number", "null"],
          "description": "Base fee from reference"
        },
        "modality": {
          "type": ["string", "null"],
          "description": "Modality from reference"
        },
        "match_confidence": {
          "type": "string",
          "enum": ["exact", "high", "moderate", "partial"],
          "description": "Confidence in match"
        },
        "match_reasoning": {
          "type": "string",
          "description": "Why this code matches"
        },
        "comparison": {
          "$ref": "#/definitions/comparison_attributes"
        },
        "applicable_modifiers": {
          "type": "array",
          "items": {"$ref": "#/definitions/applicable_modifier"}
        },
        "exclusions": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Same-day exclusions for this code"
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    }
  },
  
  "type": "object",
  "required": ["alberta_source", "matched_codes", "crosswalk_metadata"],
  "properties": {
    "crosswalk_metadata": {
      "type": "object",
      "properties": {
        "crosswalk_version": {
          "type": "string",
          "description": "Version of crosswalk system"
        },
        "generated_date": {
          "type": "string",
          "format": "date-time",
          "description": "When crosswalk was generated"
        },
        "provinces_included": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Provinces in this crosswalk"
        }
      }
    },
    "alberta_source": {
      "$ref": "#/definitions/alberta_source"
    },
    "matched_codes": {
      "type": "array",
      "items": {"$ref": "#/definitions/matched_code"}
    },
    "summary": {
      "type": "object",
      "properties": {
        "total_matches": {
          "type": "integer",
          "description": "Total matched codes across all provinces"
        },
        "matches_by_province": {
          "type": "object",
          "additionalProperties": {"type": "integer"},
          "description": "Count of matches per province"
        },
        "average_fee_ratio": {
          "type": "number",
          "description": "Average fee ratio across primary matches"
        },
        "fee_range": {
          "type": "object",
          "properties": {
            "min": {"type": "number"},
            "max": {"type": "number"},
            "min_province": {"type": "string"},
            "max_province": {"type": "string"}
          }
        },
        "flags_for_review": {
          "type": "integer",
          "description": "Count of matches requiring manual review"
        }
      }
    }
  }
}
